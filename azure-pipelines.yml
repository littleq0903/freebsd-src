# Azure Pipelines YAML file to build OS image on FreeBSD agent

trigger:
- main

jobs:
- job: Build_OS_Image
  displayName: 'Build OS Image Job'
  timeoutInMinutes: 0  # Set global timeout to unlimited
  pool:
    name: BSD-Pool

  steps:
  - script: |
      sudo cp -v -R $(Build.SourcesDirectory)/** /usr/src
    displayName: 'Copy source code to /usr/src'

  - script: |
      cd /usr/src/release
      sudo make CLOUDWARE=AZURE -DWITH_CLOUDWARE cw-azure
    displayName: 'Build Azure image'

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: '/usr/obj/usr/src/amd64.amd64/release/azure.ufs.vhdf'
      artifactName: 'azure-image'
      publishLocation: 'pipeline'
    displayName: 'Publish Azure image artifact'

- job: Upload_Image_to_Azure_Community_Gallery
  displayName: 'Upload Image to Azure Community Image Gallery'
  dependsOn: Build_OS_Image
  pool:
    name: "Azure Pipelines"

  steps:
  - task: DownloadPipelineArtifact@2
    inputs:
      artifactName: 'azure-image'
    displayName: 'Download Azure image artifact'

  - task: AzureCLI@2
    inputs:
      azureSubscription: '8f5d9c09-fe03-4887-968e-f797aa249c7b'  # Replace with your Azure service connection name
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -e  # Exit on any error

        # Variables (replace these with your actual values)
        RESOURCE_GROUP="yuas-bsd-rg"
        LOCATION="eastus"
        GALLERY_NAME="FreeBSDTestingGalleryYuas"
        IMAGE_DEFINITION="ImageDefinition"
        IMAGE_VERSION="1.0.0"
        PUBLISHER="Colin Su"
        OFFER="FREEBSD_TEST_1"
        SKU="YourSKU"
        STORAGE_ACCOUNT="yuasstorageaccount$(date +%s)"  # Unique storage account name
        CONTAINER_NAME="vhds"

        # Create resource group if it doesn't exist
        az group create --name $RESOURCE_GROUP --location $LOCATION

        # Create storage account
        az storage account create \
          --name $STORAGE_ACCOUNT \
          --resource-group $RESOURCE_GROUP \
          --location $LOCATION \
          --sku Standard_LRS

        # Get storage account key
        STORAGE_KEY=$(az storage account keys list \
          --account-name $STORAGE_ACCOUNT \
          --resource-group $RESOURCE_GROUP \
          --query '[0].value' -o tsv)

        # Create container
        az storage container create \
          --name $CONTAINER_NAME \
          --account-name $STORAGE_ACCOUNT \
          --account-key $STORAGE_KEY

        # Upload the VHD file
        az storage blob upload \
          --account-name $STORAGE_ACCOUNT \
          --container-name $CONTAINER_NAME \
          --name "azure.ufs.vhdf" \
          --file "$(Pipeline.Workspace)/azure-image/azure.ufs.vhdf" \
          --account-key $STORAGE_KEY

        # Create the image gallery if it doesn't exist
        az sig create \
          --resource-group $RESOURCE_GROUP \
          --gallery-name $GALLERY_NAME

        # Create the image definition if it doesn't exist
        az sig image-definition create \
          --resource-group $RESOURCE_GROUP \
          --gallery-name $GALLERY_NAME \
          --gallery-image-definition $IMAGE_DEFINITION \
          --publisher "$PUBLISHER" \
          --offer "$OFFER" \
          --sku "$SKU" \
          --os-type Linux

        # Create the image version
        az sig image-version create \
          --resource-group $RESOURCE_GROUP \
          --gallery-name $GALLERY_NAME \
          --gallery-image-definition $IMAGE_DEFINITION \
          --gallery-image-version $IMAGE_VERSION \
          --os-vhd-uri "https://$STORAGE_ACCOUNT.blob.core.windows.net/$CONTAINER_NAME/azure.ufs.vhdf" \
          --location $LOCATION \
          --replica-count 1 \
          --storage-account-type Standard_LRS

        # Share the image as community
        az sig share update \
          --resource-group $RESOURCE_GROUP \
          --gallery-name $GALLERY_NAME \
          --sharing-scope Community

        # Optionally, set image version publishing profile
        az sig image-version update \
          --resource-group $RESOURCE_GROUP \
          --gallery-name $GALLERY_NAME \
          --gallery-image-definition $IMAGE_DEFINITION \
          --gallery-image-version $IMAGE_VERSION \
          --target-regions "$LOCATION"
    displayName: 'Upload image to Azure Community Image Gallery'
